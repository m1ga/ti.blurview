/**
 * This file was auto-generated by the Titanium Module SDK helper for Android
 * Appcelerator Titanium Mobile
 * Copyright (c) 2009-2017 by Appcelerator, Inc. All Rights Reserved.
 * Licensed under the terms of the Apache Public License
 * Please see the LICENSE included with this distribution for details.
 */
package ti.blurview;

import android.app.Activity;
import android.graphics.Color;
import android.graphics.drawable.ColorDrawable;
import android.graphics.drawable.Drawable;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;

import org.appcelerator.kroll.KrollDict;
import org.appcelerator.kroll.annotations.Kroll;
import org.appcelerator.kroll.common.TiConfig;
import org.appcelerator.titanium.proxy.TiViewProxy;
import org.appcelerator.titanium.util.TiConvert;
import org.appcelerator.titanium.view.TiUIView;

import eightbitlab.com.blurview.BlurView;

@Kroll.proxy(creatableInModule = TiBlurViewModule.class)
public class BlurViewProxy extends TiViewProxy {
    // Standard Debugging variables
    private static final String LCAT = "BlurViewProxy";
    private static final boolean DBG = TiConfig.LOGD;
    BlurView blurLayout;
    private int blurRadius = -1;
    private int col = -1;

    // Constructor
    public BlurViewProxy() {
        super();
    }

    @Override
    public TiUIView createView(Activity activity) {
        TiUIView view = new TiBlurView(this);
        view.getLayoutParams().autoFillsHeight = true;
        view.getLayoutParams().autoFillsWidth = true;
        return view;
    }

    // Handle creation options
    @Override
    public void handleCreationDict(KrollDict options) {
        super.handleCreationDict(options);

        if (options.containsKey("blurFactor")) {
            blurRadius = TiConvert.toInt(options.get("blurRadius"), 2);
        }
        if (options.containsKey("backgroundColor")) {
            col = TiConvert.toColor(TiConvert.toString(options.get("backgroundColor"), "#88000000"));
        }
    }

    @Kroll.setProperty
    public void blurRadius(int factor) {
        blurRadius = factor;
        blurLayout.setBlurRadius(blurRadius);
    }

    @Kroll.setProperty
    public void backgroundColor(int factor) {
        col = factor;
        blurLayout.setOverlayColor(col);
    }

    @Kroll.getProperty
    public int blurRadius() {
        return blurRadius;
    }


    private class TiBlurView extends TiUIView {

        public TiBlurView(TiViewProxy proxy) {
            super(proxy);
            View viewWrapper;

            int resId_viewHolder;
            int resIdPublish;

            resId_viewHolder = R.layout.layout_main;
            resIdPublish = R.id.blurView;

            LayoutInflater inflater = LayoutInflater.from(proxy.getActivity());
            viewWrapper = inflater.inflate(resId_viewHolder, null);
            blurLayout = viewWrapper.findViewById(resIdPublish);

            Drawable windowBackground = getWindowBackground();
            if (windowBackground == null) {
                windowBackground = new ColorDrawable(Color.TRANSPARENT);
            }

            ViewGroup rootView = getRootContentView();
            if (rootView == null) {
                return;
            }

            blurLayout.setupWith(rootView).setFrameClearDrawable(windowBackground);
            if (blurRadius != -1) {
                blurLayout.setBlurRadius(blurRadius);
            }
            if (col != -1) {
                blurLayout.setOverlayColor(col);
            }

            setNativeView(viewWrapper);
        }

        private ViewGroup getRootContentView() {
            if (proxy == null || proxy.getActivity() == null || proxy.getActivity().getWindow() == null) {
                return null;
            }
            View decor = proxy.getActivity().getWindow().getDecorView();
            View content = decor.findViewById(android.R.id.content);
            if (content instanceof ViewGroup) {
                return (ViewGroup) content;
            }
            return null;
        }

        private Drawable getWindowBackground() {
            if (proxy == null || proxy.getActivity() == null || proxy.getActivity().getWindow() == null) {
                return null;
            }
            return proxy.getActivity().getWindow().getDecorView().getBackground();
        }

        @Override
        public void processProperties(KrollDict d) {
            super.processProperties(d);
        }
    }
}
